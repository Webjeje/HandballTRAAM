<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Handball – Vitesse vs Précipitation (V1)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gauge.js/1.2.1/gauge.min.js"></script>
  <style>
    :root {
      --bg-dark: #0d1117;          
      --surface-1: #161b22;        
      --surface-2: #21262d;        
      --border-color: #30363d;     
      --text-primary: #e6edf3;     
      --text-secondary: #8b949e;   
      
      --brand: #a78bfa; /* Violet pastel */
      --brand-hover: #c4b5fd;
      --ring-focus: rgba(167, 139, 250, 0.4);

      --export-color: #2da44e; /* Vert pour Export/QR */
      --export-hover: #35c55d;

      /* Couleurs sémantiques (issues du projet) */
      --n1: #f85149; /* Rouge vif */
      --n2: #f59e0b; /* Orange */
      --n3: #86efac; /* Vert clair */
      --n4: #3fb950; /* Vert vif */

      /* Ombres */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.15);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.25);
      --shadow-lg: 0 10px 30px rgba(0,0,0,0.4);

      /* Transitions & Rayon */
      --border-radius: 12px;
      --transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* --- Animation d'apparition des vues --- */
    @keyframes fadeInSlideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- Base & Typographie --- */
    *, *::before, *::after { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      background-color: var(--bg-dark);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .app { min-height: 100vh; display: flex; flex-direction: column; }

    /* --- Header & Footer (Barres de navigation) --- */
    header, footer {
      position: sticky;
      z-index: 10;
      background-color: rgba(13, 17, 23, 0.75); 
      backdrop-filter: saturate(180%) blur(10px);
      -webkit-backdrop-filter: saturate(180%) blur(10px);
    }
    header {
      top: 0;
      border-bottom: 1px solid var(--border-color);
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    footer {
      bottom: 0;
      border-top: 1px solid var(--border-color);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
    }
    header .bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      max-width: 820px;
      margin: 0 auto;
    }
    .brand { font-weight: 800; letter-spacing: .3px; }

    /* --- Layout Principal --- */
    main {
      flex: 1;
      padding: 1.5rem 1rem;
      max-width: 820px;
      width: 100%;
      margin: 0 auto;
    }
    [data-view] {
      animation: fadeInSlideUp 0.4s ease-out forwards;
    }

    /* --- Cartes (Élément principal de contenu) --- */
    .card {
      background: var(--surface-1);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
    }

    /* --- Boutons --- */
    .btn {
      appearance: none;
      border: 1px solid transparent;
      border-radius: 8px;
      padding: 0.75rem 1.25rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-size: 1rem;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    .btn:active {
      transform: translateY(-1px) scale(0.98);
      box-shadow: none;
    }
    .btn-ghost {
      background-color: transparent;
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    .btn-ghost:hover {
      background-color: var(--surface-2);
      border-color: var(--text-secondary);
    }
    .btn-danger { background-color: var(--n1); color: #fff; }
    .btn-danger:hover { background-color: #d63c34; }
    .save { background-color: var(--brand); color: var(--bg-dark); }
    .save:hover { background-color: var(--brand-hover); }

    .btn-export { background-color: var(--export-color); color: #fff; }
    .btn-export:hover { background-color: var(--export-hover); }
    .btn-reset-data { background-color: var(--n2); color: var(--bg-dark); }
    .btn-reset-data:hover { background-color: #ffb745; }

    /* --- Navigation par onglets (Footer) --- */
    .tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 10px;
    }
    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.75rem;
      padding: 8px 4px;
      font-weight: 600;
      border-radius: 8px;
      color: var(--text-secondary);
      border: none;
      background: transparent;
      transition: var(--transition);
      cursor: pointer;
    }
    .tab:hover {
      background-color: var(--surface-2);
      color: var(--text-primary);
    }
    .tab.active {
      color: var(--brand);
    }
    .tab svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-secondary);
      transition: var(--transition);
    }
    .tab:hover svg {
      stroke: var(--text-primary);
    }
    .tab.active svg {
      stroke: var(--brand);
    }

    /* --- Vue Passage --- */
    .hud { display: grid; gap: 1rem; }
    .chrono {
      font-size: clamp(3rem, 12vw, 4rem);
      font-weight: 800;
      text-align: center;
      letter-spacing: 1px;
      padding: 1rem;
      border-radius: var(--border-radius);
      background-color: var(--bg-dark);
      border: 1px solid var(--border-color);
      transition: color 0.3s ease;
    }
    .chrono.n1 { color: var(--n1); }
    .chrono.n2 { color: var(--n2); }
    .chrono.n3 { color: var(--n3); }
    .chrono.n4 { color: var(--n4); }

    .cta { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    .btn-start {
      background-color: var(--n4);
      color: var(--bg-dark);
      padding: 1rem;
      font-size: 1.5rem;
      border-radius: 8px;
    }
    .btn-passes {
      background-color: var(--surface-2);
      color: #fff;
      padding: 1.25rem;
      font-size: 2rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: background-color 0.3s ease, transform 0.15s ease;
    }
    .btn-passes.n1 { background-color: var(--n1); color: #fff; }
    .btn-passes.n2 { background-color: var(--n2); color: var(--bg-dark); }
    .btn-passes.n3 { background-color: var(--n3); color: var(--bg-dark); }
    .btn-passes.n4 { background-color: var(--n4); color: #fff; }

    .issues {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    .issue {
      padding: 1rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      color: #fff;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    .issue::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(165deg, rgba(255,255,255,0.1), rgba(0,0,0,0.3));
      opacity: 0.6;
      transition: var(--transition);
    }
    .issue:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }
    .issue:hover::before { opacity: 1; }
    .issue[disabled] {
      opacity: 0.4;
      filter: grayscale(0.5);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .issue.perte-avant { background-color: var(--n1); }
    .issue.zone-avant, .issue.zone-arriere { background-color: var(--n2); }
    .issue.tir-manque, .issue.tir-cadre { background-color: var(--n3); color: var(--bg-dark); text-shadow: none; }
    .issue.but { background-color: var(--n4); }

    /* Jauges */
    .gauges { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .gauge {
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px;
    }
    .gauge label { font-size: 12px; color: var(--text-secondary); }
    .bar {
      height: 8px;
      background: var(--surface-2);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }
    .bar > span {
      display: block;
      height: 100%;
      width: 0%;
      border-radius: 4px;
      transition: width 0.3s ease, background-color 0.3s ease;
    }

    /* --- Vue Stats --- */
    .stats-grid { display: grid; gap: 1rem; margin-top: 1rem; }
    @media(min-width: 720px) { .stats-grid { grid-template-columns: 1fr 1fr; } }

    .avg-wrap {
      display: flex;
      align-items: center;
      justify-content: center; /* MODIFIÉ */
      text-align: center; /* AJOUTÉ */
      background-color: var(--bg-dark);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
    }
    .avg-left { display: flex; flex-direction: column; gap: 4px; }
    .avg-title { font-weight: 700; color: var(--text-secondary); letter-spacing: .2px; }
    .avg-value { font-size: 3rem; font-weight: 800; line-height: 1; color: var(--brand); }
    .avg-desc { font-size: 1rem; color: var(--text-secondary); }
    
    /* MODIFICATION : On cache l'image via CSS */
    .avg-right {
      display: none;
    }

    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 1rem 0; }
    .kpi {
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      color: var(--text-secondary);
    }
    .kpi b { font-size: 1.5rem; display: block; color: var(--text-primary); margin-top: 4px; }

    /* --- Champs de formulaire & Réglages --- */
    .lock, .students { display: grid; gap: 1rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-weight: 600; color: var(--text-secondary); }
    input[type="number"], input[type="text"], input[type="password"], select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      background-color: var(--bg-dark);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      font-size: 1rem;
      transition: var(--transition);
    }
    input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus, select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px var(--ring-focus);
    }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238b949e' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }

    /* --- Modales (Dialog) --- */
    dialog {
      border: 1px solid var(--border-color);
      background-color: var(--surface-1);
      color: var(--text-primary);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      width: 90%;
      max-width: 500px;
      padding: 1.5rem;
    }
    dialog::backdrop {
      background-color: rgba(13, 17, 23, 0.6);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    dialog[open] {
      animation: fadeInSlideUp 0.3s ease-out forwards;
    }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 1.5rem; }

    /* --- Simulateur (Visuel) --- */
    #simWrap .sim-card {
      background-color: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-top: 1.5rem;
    }
    #simWrap .sim-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1.5rem;
    }
    #simWrap .field { margin-bottom: 1rem; }
    #simWrap input[type="range"] {
      width: 100%;
      accent-color: var(--brand);
      cursor: pointer;
    }
    #simWrap .issue-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    #simWrap .issue-selector input { display: none; }
    #simWrap .issue-selector label {
      display: block;
      text-align: center;
      padding: 0.6rem 0.4rem;
      border: 1px solid var(--border-color);
      background-color: var(--surface-1);
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
    }
    #simWrap .issue-selector label:hover {
      background-color: var(--surface-2);
      border-color: var(--text-secondary);
    }
    #simWrap .issue-selector input:checked + label {
      background-color: var(--brand);
      color: var(--bg-dark);
      font-weight: 700;
      border-color: var(--brand);
    }
    #simWrap .graph {
      position: relative;
      height: 400px;
      flex: 1;
      border-left: 2px solid var(--text-secondary);
      border-bottom: 2px solid var(--text-secondary);
      background-color: var(--bg-dark);
      overflow: hidden;
      border-radius: 8px;
    }
    #simWrap .zone {
      position: absolute;
      transition: all .2s ease-in-out;
      opacity: 0.9;
    }
    
    #simWrap .graph-wrap{display:flex; flex-direction:column}
    #simWrap .graph-row{display:flex; align-items:flex-end}
    #simWrap .y-title{writing-mode:vertical-rl; transform:rotate(180deg); color:var(--text-secondary); margin-right:.5rem}
    #simWrap .y-ticks{height:400px; width:26px; position:relative}
    #simWrap .x-ticks{height:20px; position:relative; margin-left:26px}
    #simWrap .tick{position:absolute; color:var(--text-secondary); font-size:.8rem}
    #simWrap .tick.y{right:4px; transform:translateY(50%)}
    #simWrap .tick.x{top:4px; transform:translateX(-50%)}
    #simWrap .lbl{position:absolute; font-weight:800; color:#000; font-size:1.1rem; display:flex; align-items:center; justify-content:center; pointer-events:none}
    
    /* --- Responsive --- */
    @media (max-width: 900px) {
      #simWrap .sim-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      header .bar { padding: 1rem; }
      main { padding: 1rem 0.5rem; }
      .card { padding: 1rem; }
      .row { grid-template-columns: 1fr; }
      .field:has(button) { justify-content: flex-end; }
      .field label:empty { display: none; }
      .avg-wrap { flex-direction: column; align-items: center; } /* MODIFIÉ */
      .kpis { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="bar">
      <div class="brand">Handball · Vitesse vs Précipitation</div>
      <button class="btn btn-ghost" id="btnResetAll" title="Réinitialiser">
        Reset
      </button>
    </div>
  </header>

  <main>
    <section id="view-passage" class="card" data-view>
      <div class="hud">
        <div id="chrono" class="chrono">00:00.0</div>

        <div class="gauges">
          <div class="gauge" id="gTime">
            <label>Temps</label>
            <div class="bar"><span></span></div>
          </div>
          <div class="gauge" id="gPasses">
            <label>Passes</label>
            <div class="bar"><span></span></div>
          </div>
          <div class="gauge" id="gIssue">
            <label>Issue</label>
            <div class="bar"><span></span></div>
          </div>
        </div>

        <div class="cta">
          <button id="btnStart" class="btn btn-start">Start</button>
          <button id="btnPass" class="btn btn-passes" style="display:none">+ Passes <span id="passCount">0</span></button>
        </div>

        <div class="issues">
          <button class="issue perte-avant"  id="i-perte"     disabled>Perte zone avant</button>
          <button class="issue zone-avant"    id="i-zavant"    disabled>Passage zone avant</button>
          <button class="issue zone-arriere"  id="i-zarriere"  disabled>Passage zone arrière</button>
          <button class="issue tir-manque"    id="i-manque"    disabled>Tir manqué</button>
          <button class="issue tir-cadre"     id="i-cadre"     disabled>Tir cadré</button>
          <button class="issue but"           id="i-but"       disabled>But marqué</button>
        </div>
      </div>
    </section>

    <section id="view-stats" class="card" data-view style="display:none">
      <div class="avg-wrap">
        <div class="avg-left">
          <div class="avg-title">Niveau moyen (1 → 4)</div>
          <div class="avg-value"><span id="avgLevelVal">—</span></div>
          <div class="avg-desc" id="avgLevelLabel">—</div>
        </div>
        <div class="avg-right">
          <img id="avgLevelImg" alt="Visuel du niveau moyen" />
        </div>
      </div>

      <div class="kpis">
        <div class="kpi"><span>Temps moyen</span><b id="kpiTime">—</b></div>
        <div class="kpi"><span>Passes moyennes</span><b id="kpiPass">—</b></div>
        <div class="kpi"><span>Passages/But</span><b id="kpiAvant">—</b></div>
      </div>

      <div class="stats-grid">
        <div class="card">
          <canvas id="chartTimes" height="180"></canvas>
        </div>
        <div class="card">
          <canvas id="chartPasses" height="180"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:1rem">
        <canvas id="chartIssues" height="200"></canvas>
      </div>

      <div class="card" style="margin-top:1rem; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn btn-export" id="btnExportCSV">Export CSV</button>
        <button class="btn btn-export" id="btnQR">QR Code</button>
      </div>
    </section>

    <section id="view-settings" class="card" data-view style="display:none">
      <div id="lockPane" class="lock">
        <p style="color:var(--text-secondary)">Espace réservé. Entrer le code PIN pour modifier les seuils.</p>
        <div class="row">
          <div class="field">
            <label for="pin">PIN</label>
            <input id="pin" type="password" inputmode="numeric" placeholder="****" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button id="btnUnlock" class="btn save">Déverrouiller</button>
          </div>
        </div>
      </div>
      <div id="settingsPane" style="display:none">
        <div class="row">
          <div class="field">
            <label>T_vite (s)</label>
            <input id="tVite" type="number" step="0.1" min="1" />
          </div>
          <div class="field">
            <label>T_lent (s)</label>
            <input id="tLent" type="number" step="0.1" min="1" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>Passes min (utile)</label>
            <input id="pMin" type="number" step="1" min="0" />
          </div>
          <div class="field">
            <label>Passes max (utile)</label>
            <input id="pMax" type="number" step="1" min="0" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>Seuil stérile (≥)</label>
            <input id="pSterile" type="number" step="1" min="0" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button id="btnSaveCfg" class="btn save">Enregistrer la config</button>
          </div>
        </div>

        <div id="simWrap" class="sim-card">
          <h3 style="margin-top:0">Visualisation des Zones de Performance</h3>
          <p style="margin:6px 0 12px; color:var(--text-secondary)">
            La carte ci-dessous se base sur <b>T_vite, T_lent, P_min, P_max, P_stérile</b>.
            Le <b>Décalage</b> et l’<b>Issue</b> appliquent un bonus/malus <em>visuel</em> pour comprendre l’incidence de la fin (sans modifier les seuils).
          </p>

          <div class="sim-grid">
            <div>
              <div class="field">
                <label for="simPreset">Préréglage rapide</label>
                <select id="simPreset">
                  <option value="custom">-- Personnalisé (valeurs actuelles) --</option>
                  <option value="facile">Facile (Découverte)</option>
                  <option value="6e">6e (Construction)</option>
                  <option value="5e">5e (Tranchant)</option>
                </select>
                <small style="color:var(--text-secondary); font-size:0.8rem;">Sélectionner un préréglage remplit les 5 champs ci-dessus.</small>
              </div>

              <div class="field">
                <label for="simDecalage">Amplitude du Décalage : <b><span id="simDecalageVal">2.0</span>s</b></label>
                <input id="simDecalage" type="range" min="0" max="5" step="0.1" value="2">
                <small style="color:var(--text-secondary); font-size:0.8rem;">Translate T_vite/T_lent selon l’issue choisie.</small>
              </div>

              <div class="field">
                <label>Issue de l’action (bonus/malus visuel)</label>
                <div class="issue-selector">
                  <div><input type="radio" name="simIssue" id="simI-but" value="but" checked><label for="simI-but">But</label></div>
                  <div><input type="radio" name="simIssue" id="simI-cadre" value="tir_cadre"><label for="simI-cadre">Tir cadré</label></div>
                  <div><input type="radio" name="simIssue" id="simI-manque" value="tir_manque"><label for="simI-manque">Tir manqué</label></div>
                  <div><input type="radio" name="simIssue" id="simI-avant" value="passage_avant"><label for="simI-avant">Zone avant</label></div>
                  <div><input type="radio" name="simIssue" id="simI-arriere" value="passage_arriere"><label for="simI-arriere">Zone arrière</label></div>
                  <div><input type="radio" name="simIssue" id="simI-perte" value="perte_avant"><label for="simI-perte">Perte</label></div>
                </div>
              </div>
            </div>

            <div class="graph-wrap">
              <div class="graph-row">
                <div class="y-title">Passes (#)</div>
                <div id="simYTicks" class="y-ticks"></div>
                <div id="simGraph" class="graph">
                  <div id="simZ-n1" class="zone"></div><div id="simZ-n2a" class="zone"></div><div id="simZ-n2b" class="zone"></div><div id="simZ-n2c" class="zone"></div><div id="simZ-n2d" class="zone"></div><div id="simZ-n3" class="zone"></div><div id="simZ-n4" class="zone"></div>
                  <div id="simL-n1" class="lbl">N1</div><div id="simL-n2" class="lbl">N2</div><div id="simL-n3" class="lbl">N3</div><div id="simL-n4" class="lbl">N4</div>
                </div>
              </div>
              <div id="simXTicks" class="x-ticks"></div>
              <div class="axis-title" style="text-align:center; color:var(--text-secondary); margin-top: 4px;">⬅ Temps (secondes)</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="view-students" class="card" data-view style="display:none">
      <div class="students">
        <div class="row">
          <div class="field"><label>Attaquant 1</label><input id="s1" type="text" placeholder="Nom prénom" /></div>
          <div class="field"><label>Attaquant 2</label><input id="s2" type="text" placeholder="Nom prénom" /></div>
        </div>
        <div class="row">
          <div class="field"><label>Attaquant 3</label><input id="s3" type="text" placeholder="Nom prénom" /></div>
          <div class="field"><label>&nbsp;</label><button id="btnSaveNames" class="btn save">Enregistrer noms</button></div>
        </div>
        <div class="card" style="margin-top:1rem; background-color: var(--bg-dark);">
          <p style="color:var(--text-secondary); margin-top:0">Exporter l'archivage complet des passages.</p>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn btn-export" id="btnExportCSV2">Export CSV</button>
            <button class="btn btn-export" id="btnQR2">QR Code</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="tabs">
      <button class="tab active" data-tab="passage">
        <svg xmlns="http://www.w3.org/2000/svg" class="ionicon" viewBox="0 0 512 512" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"><path d="M256 64C150 64 64 150 64 256s86 192 192 192 192-86 192-192S362 64 256 64z"/><path d="M256 128v128h96"/></svg>
        <span>Passage</span>
      </button>
      <button class="tab" data-tab="stats">
        <svg xmlns="http://www.w3.org/2000/svg" class="ionicon" viewBox="0 0 512 512" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"><path d="M32 32v432a16 16 0 0016 16h432M320 320l-80-80-80 80-80-80"/><path d="M480 32l-144 144-80-80-80 80-48-48"/></svg>
        <span>Stats</span>
      </button>
      <button class="tab" data-tab="settings">
        <svg xmlns="http://www.w3.org/2000/svg" class="ionicon" viewBox="0 0 512 512" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"><path d="M421.88 288.27l-27.55-15.12a64 64 0 00-36.56-102.42l15.12-27.55a16 16 0 00-6.95-21.84l-42.34-24.44a16 16 0 00-21.84 6.95l-15.12 27.55a64 64 0 00-102.42-36.56l-27.55-15.12a16 16 0 00-21.84 6.95l-24.44 42.34a16 16 0 006.95 21.84l27.55 15.12a64 64 0 0036.56 102.42l-15.12 27.55a16 16 0 006.95 21.84l42.34 24.44a16 16 0 0021.84-6.95l15.12-27.55a64 64 0 00102.42 36.56l27.55 15.12a16 16 0 0021.84-6.95l24.44-42.34a16 16 0 00-6.95-21.84zM256 320a64 64 0 1164-64 64.07 64.07 0 01-64 64z"/></svg>
        <span>Réglages</span>
      </button>
      <button class="tab" data-tab="students">
        <svg xmlns="http://www.w3.org/2000/svg" class="ionicon" viewBox="0 0 512 512" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"><path d="M336 256c-20.56 0-40.44-9.18-56-25.84-15.13-16.25-24.6-40-24.6-65.41 0-42.33 25.34-78.75 62.6-78.75S380 122.42 380 164.75c0 25.46-9.51 49.2-24.69 65.51-15.52 16.59-35.37 25.74-55.81 25.74zM176 256c-20.56 0-40.44-9.18-56-25.84-15.13-16.25-24.6-40-24.6-65.41 0-42.33 25.34-78.75 62.6-78.75S220 122.42 220 164.75c0 25.46-9.51 49.2-24.69 65.51-15.52 16.59-35.37 25.74-55.81 25.74z"/><path d="M312 304c-11.25 0-22.14 2.45-32.34 7.06-11.45 5.18-22.18 12.89-30.82 22.53-8.81 9.82-15.59 21.6-19.12 34.46-3.82 13.8-4.72 28.53-4.72 43.19 0 16.45 13.34 29.79 29.79 29.79h132.32c16.45 0 29.79-13.34 29.79-29.79 0-14.66-.9-29.39-4.72-43.19-3.53-12.86-10.31-24.64-19.12-34.46-8.64-9.64-19.37-17.35-30.82-22.53C334.14 306.45 323.25 304 312 304zM152 304c-11.25 0-22.14 2.45-32.34 7.06-11.45 5.18-22.18 12.89-30.82 22.53-8.81 9.82-15.59 21.6-19.12 34.46-3.82 13.8-4.72 28.53-4.72 43.19 0 16.45 13.34 29.79 29.79 29.79h132.32c16.45 0 29.79-13.34 29.79-29.79 0-14.66-.9-29.39-4.72-43.19-3.53-12.86-10.31-24.64-19.12-34.46-8.64-9.64-19.37-17.35-30.82-22.53C174.14 306.45 163.25 304 152 304z"/></svg>
        <span>Élèves</span>
      </button>
    </div>
  </footer>
</div>

<dialog id="modalQR">
  <h3>QR Code – Stats (CSV)</h3>
  <canvas id="qrCanvas" width="240" height="240" style="border-radius: 8px;"></canvas>
  <div class="modal-actions">
    <button class="btn btn-ghost" id="closeQR">Fermer</button>
  </div>
</dialog>

<dialog id="modalReset">
  <h3>Reset général</h3>
  <p>Que souhaitez-vous réinitialiser ?</p>
  <div class="modal-actions" style="flex-direction: column; align-items: stretch; gap: 1rem;">
    <button class="btn btn-danger" id="resetAll">Tout (données + réglages + noms)</button>
    <button class="btn btn-reset-data" id="resetData">Seulement les données</button>
    <button class="btn btn-ghost" id="resetCancel">Annuler</button>
  </div>
</dialog>

<dialog id="modalResult">
  <h3 style="text-align:center;">Bilan du passage</h3>
  <p id="resultText" style="text-align:center; font-size:18px; line-height: 1.6;"></p>
  <div class="modal-actions">
    <button class="btn save" id="closeResult">OK</button>
  </div>
</dialog>

<script>
  // Le JavaScript reste INCHANGÉ
  const lvlColor = lvl => ({1:'var(--n1)',2:'var(--n2)',3:'var(--n3)',4:'var(--n4)'}[lvl]||'var(--text)');
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const LS_KEY_CFG = 'hb_cfg_v1', LS_KEY_DATA = 'hb_passages_v1', LS_KEY_NAMES = 'hb_names_v1';
  const defaults = { seuils:{T_vite:8.0, T_lent:18.0, P_min:2, P_max:4, P_sterile:6} };
  let cfg = loadCfg(), passages = loadPassages(), names = loadNames();
  function loadCfg(){ const raw = localStorage.getItem(LS_KEY_CFG); if(!raw) return structuredClone(defaults); try{ const o = JSON.parse(raw); return {seuils:{...defaults.seuils, ...(o.seuils||{})}}; }catch(e){ return structuredClone(defaults); } }
  function saveCfg(){ localStorage.setItem(LS_KEY_CFG, JSON.stringify(cfg)); }
  function loadPassages(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_DATA)||'[]'); }catch{ return []; } }
  function savePassages(){ localStorage.setItem(LS_KEY_DATA, JSON.stringify(passages)); }
  function loadNames(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_NAMES)||'["","",""]'); }catch{ return ["","",""]; } }
  function saveNames(){ localStorage.setItem(LS_KEY_NAMES, JSON.stringify(names)); }
  const $ = sel => document.querySelector(sel), $$ = sel => document.querySelectorAll(sel);
  const chronoEl = $('#chrono'), passBtn = $('#btnPass'), passCountEl = $('#passCount'), startBtn = $('#btnStart');
  const issueBtns = { perte: $('#i-perte'), zavant: $('#i-zavant'), zarriere: $('#i-zarriere'), manque: $('#i-manque'), cadre: $('#i-cadre'), but: $('#i-but') };
  const gTime = $('#gTime .bar span'), gPass = $('#gPasses .bar span'), gIssue = $('#gIssue .bar span');
  $$('.tab').forEach(t=>t.addEventListener('click',()=>switchTab(t.dataset.tab)));
  function switchTab(tab){
    $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
    $$('[data-view]').forEach(v => v.style.display = 'none');
    const view = $(`[data-view]#view-${tab}`);
    if(view) view.style.display = 'block';
    if(tab==='stats') renderCharts();
    if(tab==='settings') loadSettingsUI();
    if(tab==='students') loadStudentsUI();
  }
  let state = 'idle', startTs = 0, raf = 0, passesCount = 0;
  function fmtTime(ms){ const s = ms/1000, m = Math.floor(s/60), sec = (s%60).toFixed(1).padStart(4,'0'); return `${String(m).padStart(2,'0')}:${sec}`; }
  function tick(){
    const ms = performance.now() - startTs;
    chronoEl.textContent = fmtTime(ms);
    const {T_vite,T_lent} = cfg.seuils;
    const sec = ms/1000;
    let tPct = 0, tClass='';
    if(sec<=T_vite){ tPct = clamp(sec/T_vite*100,0,100); tClass='n4'; }
    else if(sec<=T_lent){ tPct = clamp(100*(sec-T_vite)/(T_lent-T_vite),0,100); tClass='n3'; }
    else { tPct = 100; tClass='n2'; }
    chronoEl.className = `chrono ${tClass}`;
    gTime.style.width = `${tPct}%`;
    gTime.style.background = getComputedStyle(document.documentElement).getPropertyValue(tClass==='n4'?'--n4':tClass==='n3'?'--n3':'--n2');
    const {P_min,P_max,P_sterile} = cfg.seuils;
    let pPct=0, pCol='--n1';
    if(passesCount<=1){ pPct=clamp(passesCount/1*33,0,33); pCol='--n1'; }
    if(passesCount>=P_min && passesCount<=P_max){ pPct=66; pCol='--n3'; }
    if(passesCount>=P_sterile){ pPct=100; pCol='--n2'; }
    gPass.style.width = `${pPct}%`; gPass.style.background = getComputedStyle(document.documentElement).getPropertyValue(pCol);
    const pred = predictLevel(sec, passesCount);
    passBtn.className = `btn btn-passes ${'n'+pred}`;
    raf = requestAnimationFrame(tick);
  }
  function predictLevel(sec, passes){
    const {T_vite,T_lent,P_min,P_max,P_sterile} = cfg.seuils;
    if(sec<=T_vite && passes>=P_min && passes<=P_max) return 4;
    if(sec>T_lent || passes>=P_sterile) return 2;
    if(sec>T_vite && sec<=T_lent && passes>=P_min && passes<=P_max) return 3;
    if(passes<=1) return 1;
    return 2;
  }
  startBtn.addEventListener('click', ()=>{
    if(state!=='idle') return;
    state='running'; passesCount=0; passCountEl.textContent='0'; startTs=performance.now();
    startBtn.style.display='none'; passBtn.style.display='flex';
    setIssuesEnabled(true);
    gIssue.style.width='0%'; gIssue.style.background='var(--n3)';
    requestAnimationFrame(tick); vibe(10);
  });
  passBtn.addEventListener('click', ()=>{
    if(state!=='running') return;
    passesCount++; passCountEl.textContent=String(passesCount);
    passBtn.style.transform='scale(1.02)';
    setTimeout(()=>passBtn.style.transform='scale(1)',90);
    vibe(6);
  });
  Object.entries(issueBtns).forEach(([key,btn])=>btn.addEventListener('click', ()=>{ if(state==='running') endPassage(key); }));
  function setIssuesEnabled(on){ Object.values(issueBtns).forEach(b=>b.disabled=!on); }
  function endPassage(issueKey){
    cancelAnimationFrame(raf);
    const ms = performance.now()-startTs, sec = Math.max(0, ms/1000);
    const issueMap={ perte:'perte_avant', zavant:'passage_avant', zarriere:'passage_arriere', manque:'tir_manque', cadre:'tir_cadre', but:'but' };
    const issue = issueMap[issueKey]||'perte_avant';
    let col='var(--n1)';
    if(issue==='perte_avant') col='var(--n1)';
    else if(issue==='passage_avant' || issue==='passage_arriere') col='var(--n2)';
    else if(issue==='tir_manque' || issue==='tir_cadre') col='var(--n3)';
    else if(issue==='but') col='var(--n4)';
    gIssue.style.width='100%'; gIssue.style.background=col;
    const niveau = computeLevel(sec, passesCount, issue);
    const rec={ id:`P-${Date.now()}`, eleve:`${names[0]}|${names[1]}|${names[2]}`.trim(), temps_s: Number(sec.toFixed(1)), passes: passesCount, issue, ordre_issue: ['perte_avant','passage_avant','passage_arriere','tir_manque','tir_cadre','but'].indexOf(issue)+1, niveau_calcule: niveau, seance: 1, horodatage: new Date().toISOString() };
    passages.push(rec); savePassages();
    $('#resultText').innerHTML = `Temps: <strong>${rec.temps_s}s </strong> <br> Passe(s): <strong>${rec.passes}</strong><br>  Zone: <strong>${labelIssue(issue)}</strong><br><b style="font-size:24px; color:${lvlColor(niveau)}">Niveau ${niveau}</b>`;
    $('#modalResult').showModal();
    state='idle'; startBtn.style.display='block'; passBtn.style.display='none';
    setIssuesEnabled(false);
    chronoEl.textContent='00:00.0'; chronoEl.className='chrono'; passCountEl.textContent='0';
    if($('#view-stats').style.display!=='none') renderCharts();
  }
  function computeLevel(sec, passes, issue){
    const {T_vite,T_lent,P_min,P_max,P_sterile} = cfg.seuils;
    const isAvant = (issue==='perte_avant' || issue==='passage_avant' || issue==='tir_manque' || issue==='tir_cadre' || issue==='but');
    const isSuccess = (issue==='tir_cadre' || issue==='but');
    if(isSuccess && isAvant && sec<=T_vite && passes>=P_min && passes<=P_max) return 4;
    if(isSuccess && isAvant && sec>T_vite && sec<=T_lent) return 3;
    if(issue==='passage_arriere' || sec>T_lent || passes>=P_sterile) return 2;
    if(passes<=1 || issue==='perte_avant') return 1;
    return 2;
  }
  function labelIssue(i){ return ({ perte_avant:'Perte Z avant', passage_avant:'Passage Z avant', passage_arriere:'Passage Z arrière', tir_manque:'Tir manqué', tir_cadre:'Tir cadré', but:'But marqué' })[i]||i; }
  function vibe(ms){ if(navigator.vibrate) navigator.vibrate(ms); }
  let chartTimes, chartPasses, chartIssues;
  function renderCharts(){
    const labels = passages.map((p,i)=>`#${i+1}`), times = passages.map(p=>p.temps_s), passesArr = passages.map(p=>p.passes);
    const avg = a => a.length? (a.reduce((x,y)=>x+y,0)/a.length):0;
    const avgT = avg(times), avgP = avg(passesArr);
    $('#kpiTime').textContent = avgT? `${avgT.toFixed(1)} s` : '—';
    $('#kpiPass').textContent = avgP? `${avgP.toFixed(1)}` : '—';
    const buts = passages.filter(p=>p.issue==='but').length, pctButs = passages.length? Math.round(100*buts/ passages.length):0;
    $('#kpiAvant').textContent = passages.length? `${pctButs}% buts` : '—';
    const avgLevel = avg(passages.map(p => p.niveau_calcule)), avgLevelRounded = passages.length ? Math.max(1, Math.min(4, Number(avgLevel.toFixed(1)))) : null;
    $('#avgLevelVal').textContent = avgLevelRounded ? avgLevelRounded.toFixed(1).replace('.', ',') : '—';
    const levelDesc = v => { if(v === null) return '—'; if(v >= 3.8) return 'N4 · Vite efficace'; if(v >= 3.0) return 'N3 · Lent efficace'; if(v >= 2.0) return 'N2 · Lent pas efficace'; return 'N1 · Panique'; };
    $('#avgLevelLabel').textContent = levelDesc(avgLevelRounded);
    const levelImageKey = v => { if(v === null) return 0; if(v >= 3.8) return 4; if(v >= 3.0) return 3; if(v >= 2.0) return 2; return 1; };
    const imgKey = levelImageKey(avgLevelRounded), imgEl = $('#avgLevelImg');
    if(imgEl) { // On vérifie que l'élément existe avant de le manipuler
        if(imgKey){ imgEl.src = `https://via.placeholder.com/98x98/${{1:'f85149',2:'f59e0b',3:'86efac',4:'3fb950'}[imgKey]}/0d1117?text=N${imgKey}`; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; }
    }
    const css = getComputedStyle(document.documentElement), textColor = css.getPropertyValue('--text-primary').trim(), gridColor = css.getPropertyValue('--border-color').trim();
    const Cn1=css.getPropertyValue('--n1').trim(), Cn2=css.getPropertyValue('--n2').trim(), Cn3=css.getPropertyValue('--n3').trim(), Cn4=css.getPropertyValue('--n4').trim();
    const chartOptions = { responsive:true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid:{color:gridColor}, ticks:{color:textColor} }, x: { grid:{color:gridColor}, ticks:{color:textColor} } }, plugins: { legend: { labels: { color: textColor } } } };
    if(chartTimes) chartTimes.destroy();
    chartTimes = new Chart($('#chartTimes'), { type:'line', data:{ labels, datasets:[{ label:'Temps (s)', data:times, borderColor:Cn1, backgroundColor:Cn1+'33', pointRadius:3, tension:0.3, fill:true }]}, options:chartOptions });
    if(chartPasses) chartPasses.destroy();
    chartPasses = new Chart($('#chartPasses'), { type:'line', data:{ labels, datasets:[{ label:'Passes (#)', data:passesArr, borderColor:Cn3, backgroundColor:Cn3+'33', pointRadius:3, tension:0.3, fill:true }]}, options:chartOptions });
    const order = ['perte_avant','passage_avant','passage_arriere','tir_manque','tir_cadre','but'], counts = order.map(k=>passages.filter(p=>p.issue===k).length);
    const issueColors = order.map(k=>{ if(k==='perte_avant') return Cn1; if(k==='passage_avant' || k==='passage_arriere') return Cn2; if(k==='tir_manque' || k==='tir_cadre') return Cn3; if(k==='but') return Cn4; return '#999'; });
    if(chartIssues) chartIssues.destroy();
    chartIssues = new Chart($('#chartIssues'), { type:'bar', data:{ labels:order.map(labelIssue), datasets:[{ label:'Occurrences', data:counts, backgroundColor:issueColors, borderRadius: 4 }] }, options:chartOptions });
  }
  function toCSV(){ const bom='\uFEFF', header=['date','attaquant1','attaquant2','attaquant3','temps_s','passes','issue','niveau'], rows = passages.map(p=>[p.horodatage, names[0]||'', names[1]||'', names[2]||'', p.temps_s, p.passes, p.issue, p.niveau_calcule]), csv = [header.join(','), ...rows.map(r=>r.join(','))].join('\n'); return bom + csv; }
  function downloadCSV(){ const blob = new Blob([toCSV()], {type:'text/csv;charset=utf-8;'}), url = URL.createObjectURL(blob), a = document.createElement('a'); a.href=url; a.download='handball_vitesse_stats.csv'; a.click(); URL.revokeObjectURL(url); }
  $('#btnExportCSV').addEventListener('click', downloadCSV); $('#btnExportCSV2').addEventListener('click', downloadCSV);
  function showQR(){
    const times = passages.map(p=>p.temps_s), passesArr = passages.map(p=>p.passes), avg = a => a.length ? (a.reduce((x,y)=>x+y,0)/a.length) : 0;
    const summary = `Bilan Handball (${new Date().toLocaleDateString()})\nTotal Actions: ${passages.length}\nTemps moyen: ${avg(times).toFixed(1)}s\nPasses moy: ${avg(passesArr).toFixed(1)}\nButs: ${passages.filter(p=>p.issue==='but').length}\nNiveau moyen: ${avg(passages.map(p => p.niveau_calcule)).toFixed(2)}`.trim();
    new QRious({ element: $('#qrCanvas'), value: summary, size: 240, level:'L', background: '#e6edf3', foreground: '#0d1117' });
    $('#modalQR').showModal();
  }
  $('#btnQR').addEventListener('click', showQR); $('#btnQR2').addEventListener('click', showQR);
  $('#closeQR').addEventListener('click', ()=>$('#modalQR').close()); $('#closeResult').addEventListener('click', ()=>$('#modalResult').close());
  function loadSettingsUI(){ $('#tVite').value = cfg.seuils.T_vite; $('#tLent').value = cfg.seuils.T_lent; $('#pMin').value = cfg.seuils.P_min; $('#pMax').value = cfg.seuils.P_max; $('#pSterile').value = cfg.seuils.P_sterile; }
  $('#btnUnlock').addEventListener('click', ()=>{ if($('#pin').value.trim()==='2025'){ sessionStorage.setItem('hb_unlocked','1'); $('#lockPane').style.display='none'; $('#settingsPane').style.display='block'; } else { alert('PIN incorrect'); } });
  if(sessionStorage.getItem('hb_unlocked')==='1'){ $('#lockPane').style.display='none'; $('#settingsPane').style.display='block'; }
  $('#btnSaveCfg').addEventListener('click', ()=>{
    cfg.seuils.T_vite = parseFloat($('#tVite').value)||defaults.seuils.T_vite; cfg.seuils.T_lent = parseFloat($('#tLent').value)||defaults.seuils.T_lent;
    cfg.seuils.P_min = parseInt($('#pMin').value)||defaults.seuils.P_min; cfg.seuils.P_max = parseInt($('#pMax').value)||defaults.seuils.P_max; cfg.seuils.P_sterile = parseInt($('#pSterile').value)||defaults.seuils.P_sterile;
    saveCfg(); alert('Configuration enregistrée.');
    sessionStorage.removeItem('hb_unlocked'); $('#lockPane').style.display='block'; $('#settingsPane').style.display='none'; $('#pin').value = '';
    switchTab('passage');
  });
  function loadStudentsUI(){ $('#s1').value=names[0]||''; $('#s2').value=names[1]||''; $('#s3').value=names[2]||''; }
  $('#btnSaveNames').addEventListener('click', ()=>{ names=[ $('#s1').value, $('#s2').value, $('#s3').value ]; saveNames(); alert('Noms enregistrés.'); });
  $('#btnResetAll').addEventListener('click', ()=>$('#modalReset').showModal());
  $('#resetCancel').addEventListener('click', ()=>$('#modalReset').close());
  $('#resetData').addEventListener('click', ()=>{ passages=[]; savePassages(); $('#modalReset').close(); if($('#view-stats').style.display !== 'none') renderCharts(); alert('Données effacées.'); });
  $('#resetAll').addEventListener('click', ()=>{ localStorage.clear(); sessionStorage.clear(); cfg=loadCfg(); passages=loadPassages(); names=loadNames(); $('#modalReset').close(); switchTab('passage'); alert('Tout a été réinitialisé.'); });
  const simMAX_TIME = 30, simMAX_PASSES = 12, simPASS_PANIC = 2;
  const simIssueWeights = { but:-1.5, tir_cadre:-1.0, tir_manque:-0.5, passage_avant:0, passage_arriere:1.0, perte_avant:1.5 };
  const sim = { dec: $('#simDecalage'), decVal: $('#simDecalageVal'), issue: $$('input[name="simIssue"]'), xticks: $('#simXTicks'), yticks: $('#simYTicks'), zones: { n1: $('#simZ-n1'), n2a: $('#simZ-n2a'), n2b: $('#simZ-n2b'), n2c: $('#simZ-n2c'), n2d: $('#simZ-n2d'), n3: $('#simZ-n3'), n4: $('#simZ-n4') }, labels: { n1: $('#simL-n1'), n2: $('#simL-n2'), n3: $('#simL-n3'), n4: $('#simL-n4') } };
  function simGenTicks(){
    if(!sim.xticks || !sim.yticks) return;
    sim.xticks.innerHTML=''; sim.yticks.innerHTML='';
    for(let t=0;t<=simMAX_TIME;t+=5){ const s=document.createElement('span'); s.className='tick x'; s.textContent=t; s.style.left = `${((simMAX_TIME-t)/simMAX_TIME)*100}%`; sim.xticks.appendChild(s); }
    for(let p=0;p<=simMAX_PASSES;p+=2){ const s=document.createElement('span'); s.className='tick y'; s.textContent=p; s.style.bottom = `${(p/simMAX_PASSES)*100}%`; sim.yticks.appendChild(s); }
  }
  function simSetRect(el, x, y, w, h, color){ if(!el) return; w=Math.max(0,w); h=Math.max(0,h); el.style.left = `${x}%`; el.style.bottom = `${y}%`; el.style.width = `${w}%`; el.style.height = `${h}%`; if(color) el.style.background = color; }
  function simSetLabel(el, x, y, w, h){ if(!el) return; w=Math.max(0,w); h=Math.max(0,h); el.style.left = `${x}%`; el.style.bottom = `${y}%`; el.style.width = `${w}%`; el.style.height = `${h}%`; el.style.display = (w<10||h<10)?'none':'flex'; }
  const simX = time => ((simMAX_TIME - time)/simMAX_TIME)*100, simY = passes => (passes/simMAX_PASSES)*100;
  const simPresets = { facile: { T_vite:10, T_lent:22, P_min:2, P_max:6, P_sterile:8 }, '6e': { T_vite:9,  T_lent:20, P_min:2, P_max:5, P_sterile:7 }, '5e': { T_vite:7,  T_lent:18, P_min:2, P_max:4, P_sterile:6 }, };
  function simApplyPreset(key){ if(!simPresets[key]) return; const p=simPresets[key]; $('#tVite').value=p.T_vite; $('#tLent').value=p.T_lent; $('#pMin').value=p.P_min; $('#pMax').value=p.P_max; $('#pSterile').value=p.P_sterile; simUpdate(); }
  function simUpdate(){
    if(!$('#simGraph')) return;
    sim.decVal.textContent = parseFloat(sim.dec.value).toFixed(1);
    let tVite = parseFloat($('#tVite').value)||defaults.seuils.T_vite, tLent = parseFloat($('#tLent').value)||defaults.seuils.T_lent;
    let pMin = parseInt($('#pMin').value)||defaults.seuils.P_min, pMax = parseInt($('#pMax').value)||defaults.seuils.P_max, pSt = parseInt($('#pSterile').value)||defaults.seuils.P_sterile;
    const issue = (Array.from(sim.issue).find(r=>r.checked)||{value:'passage_avant'}).value;
    const offset = simIssueWeights[issue] * parseFloat(sim.dec.value);
    let effVite = tVite - offset, effLent = tLent - offset;
    if(effLent < effVite) effLent = effVite;
    pMin = Math.max(pMin, simPASS_PANIC); pMax = Math.max(pMax, pMin); pSt = Math.max(pSt, pMax);
    const xV = simX(effVite), xL = simX(effLent), yP = simY(simPASS_PANIC), yMin = simY(pMin), yMax = simY(pMax), ySt = simY(pSt);
    const cs = getComputedStyle(document.documentElement), C1=cs.getPropertyValue('--n1').trim(), C2=cs.getPropertyValue('--n2').trim(), C3=cs.getPropertyValue('--n3').trim(), C4=cs.getPropertyValue('--n4').trim();
    simSetRect(sim.zones.n4, xV, yMin, 100-xV, yMax-yMin, C4); simSetRect(sim.zones.n3, xL, yP, xV-xL, ySt-yP, C3); simSetRect(sim.zones.n1, 0, 0, 100, yP, C1);
    simSetRect(sim.zones.n2a,0, yP, xL, 100-yP, C2); simSetRect(sim.zones.n2b,xL, ySt, 100-xL, 100-ySt, C2);
    simSetRect(sim.zones.n2c,xV, yP, 100-xV, yMin-yP, C2); simSetRect(sim.zones.n2d,xV, yMax, 100-xV, ySt-yMax, C2);
    simSetLabel(sim.labels.n4, xV, yMin, 100-xV, yMax-yMin); simSetLabel(sim.labels.n3, xL, yP, xV-xL, ySt-yP); simSetLabel(sim.labels.n1, 0, 0, 100, yP); simSetLabel(sim.labels.n2, 0, yP, xL, 100-yP);
  }
  function simInitOnce(){ if(sim.__inited) return; simGenTicks(); simUpdate(); sim.__inited = true; }
  const simPresetEl = $('#simPreset');
  if(simPresetEl) simPresetEl.addEventListener('change', e => { if(e.target.value !== 'custom') simApplyPreset(e.target.value); });
  if(sim.dec) sim.dec.addEventListener('input', simUpdate);
  sim.issue.forEach(r=>r.addEventListener('change', simUpdate));
  ['#tVite','#tLent','#pMin','#pMax','#pSterile'].forEach(id=>{ const el=$(id); if(!el) return; el.addEventListener('input', ()=>{ if(simPresetEl) simPresetEl.value='custom'; simUpdate(); }); });
  $$('.tab').forEach(t => t.addEventListener('click', () => { if(t.dataset.tab === 'settings'){ simInitOnce(); simUpdate(); } }));
  setIssuesEnabled(false);
</script>
</body>
</html>